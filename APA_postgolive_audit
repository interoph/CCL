/***************
Original Query published by CHC 2010 by David Peacock


updates and modifications starting 3/27/2018

******************/
select
Order_ID = o.order_id
,Name=p.NAME_FULL_FORMATTED
,FIN=ea.alias
,Facility= (uar_get_code_display(e.LOC_FACILITY_CD))
,PRIMARY_MNEMONIC=O.HNA_ORDER_MNEMONIC
,Order_Display = o.DEPT_MISC_LINE
,Item_ID = op.Item_ID
,Powerplan_Order =o.PATHWAY_CATALOG_ID
,Updt_DT_TM =op.updt_dt_tm
,Auto_Assign_Flag=op.auto_assign_flag
,OrderingPerson = prs.name_full_formatted
/*indicates if pharmacy verification is needed:
  0 - does not need verification;
  1 - needs verification;
  2 - rejected or halted.  not applicable for continuing child orders 
  ( template_order_flag of 2, 3, 4, or 6)
*/
,NEED_RX_VERIFY_IND=O.NEED_RX_VERIFY_IND

; RAVA
/*flag representing current order catalog's auto verification settings for discern alerts.  
for iv set, this is the flag on the catalog of the matching iv set.
FLAG_VALUE	DESCRIPTION				DEFINITION
0.00    	Not set					Not set
1.00		No						No auto verification performed
2.00		No w/Clinical Checking	If alerts exist, auto verification is not performed
3.00		Yes w/Reason			Only auto verify if a reason was provided with the alert(s).
4.00		Yes						Auto verify regardless of alerts.
*/
, rava.discern_auto_verify_flag

/*
flag representing current order catalog's auto verification settings for interaction checking.  
for iv set, this is the flag on the catalog of the matching iv set.
FLAG_VALUE	DESCRIPTION				DEFINITION
0.00		Not set					Not set
1.00		No						No auto verification performed.
2.00		No w/Clinical Checking	If alerts exist, auto verification is not performed.
3.00		Yes w/Reason			Only auto verify if a reason was provided with the alert(s).
4.00		Yes						Auto verify regardless of alerts.

*/
, rava.ic_auto_verify_flag
;rpaga
, uar_get_code_display(rpaga.encntr_type_cd)
, rpaga.continuous_filter_ind
, rpaga.intermittent_filter_ind
, rpaga.med_filter_ind
,Order_Route = uar_get_code_display(rpaga.route_cd)
,Order_Form =  uar_get_code_display(rpaga.form_cd)
,Patient_Location = uar_get_code_display(rpaga.pat_locn_cd)
,Facility = uar_get_code_display(rpaga.facility_cd)
;Rpaia
,Order_Free_text_Dose = rpaia.freetext_dose
,Order_Strength = rpaia.strength
,Order_Strength_unit = uar_get_code_display(rpaia.strength_unit_cd)
,Order_volume = rpaia.volume
,Order_volume_unit = uar_get_code_display(rpaia.volume_unit_cd)
; RPAA
/*
text description of a specific event that occurred during the auto product assignment process.
*/
, rpaa.status_message
/*
0: audit - find a match successfully.  matching item is recorded in set_item_id or item_id field.
1: info - fail to match because of reasons recorded in status_number and status_string fields
FLAG_VALUE	DESCRIPTION		DEFINITION
0.00		Audit			Found a match successfully.  Matching item is recorded in set_item_id or item_id field
1.00		Info			Fail to match because of reasons recorded in status_number and status_string fields
2.00		Debug			Additional information about a specific event with details recorded in status_number and status_string fields.
*/
,rpaa.status_number
, rpaa.report_level_flag




from
order_product OP
,orders o
, RX_AUTO_VERIFY_AUDIT RAVA
, RX_PRODUCT_ASSIGN_GROUP_AUDIT RPAGA
, RX_PRODUCT_ASSIGN_ITEM_AUDIT RPAIA
, RX_PRODUCT_ASSIGN_AUDIT RPAA
,encntr_alias ea
,encounter e
,person p
,prsnl prs
,dummyt d

plan OP
where op.auto_assign_flag not in (0, 1)

join o
where op.order_id = o.order_id 
and o.orig_order_dt_tm between cnvtdatetime("01-JAN-2018 0000") and cnvtdatetime("01-FEB-2018 2359")

join RAVA
where rava.order_id = outerjoin(o.order_id)

join RPAGA
where rpaga.catalog_group_id = rava.catalog_group_id

join rpaia
Where rpaia.catalog_group_id = rpaga.catalog_group_id

join rpaa
where rpaa.catalog_group_id = rava.catalog_group_id


join ea
where o.encntr_id =ea.encntr_id
and EA.ENCNTR_ALIAS_TYPE_CD =1077

join e
where ea.encntr_id = e.encntr_id
and e.loc_facility_cd in(
						;CODE_VALUE	DISPLAY
						21198290	;location
						,271998575	;location
						,271998583	;location
						,271998479	;location
						,276041517	;location
						,276497813	;location
						,344062579	;location
						,349503863	;location
						,499091795	;location
						,516280427	;location
						,416024841	;location
						,428514323	;location
						,275964153	;location
						,275964173	;location
						)
 
join p
where e.person_id = p.person_id
;and p.NAME_LAST_KEY != "PRODTEST"  ;  If you have a standard naming convention for Test Patients, you can exlude them from the report.  

join prs
where o.ACTIVE_STATUS_PRSNL_ID = prs.person_id
;and prs.POSITION_CD not in (441, 2356532) 

join d

with outerjoin = d,nullreport, time = 300

go
